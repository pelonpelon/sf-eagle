window.wp=window.wp||{};(function(e){var t,n,r,i,s,o;o=wp.media=function(e){var t=o.view.MediaFrame,n;if(!t)return;e=_.defaults(e||{},{frame:"select"});"select"===e.frame&&t.Select?n=new t.Select(e):"post"===e.frame&&t.Post&&(n=new t.Post(e));delete e.frame;return n};_.extend(o,{model:{},view:{},controller:{},frames:{}});s=o.model.l10n=typeof _wpMediaModelsL10n=="undefined"?{}:_wpMediaModelsL10n;o.model.settings=s.settings||{};delete s.settings;i=function(e,t,n,r){return _.isEqual(e,t)?n===r?0:n>r?-1:1:e>t?-1:1};_.extend(o,{template:_.memoize(function(t){var n,r={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(i){n=n||_.template(e("#tmpl-"+t).html(),null,r);return n(i)}}),post:function(e,t){return o.ajax({data:_.isObject(e)?e:_.extend(t||{},{action:e})})},ajax:function(t,n){if(_.isObject(t))n=t;else{n=n||{};n.data=_.extend(n.data||{},{action:t})}n=_.defaults(n||{},{type:"POST",url:o.model.settings.ajaxurl,context:this});return e.Deferred(function(t){n.success&&t.done(n.success);n.error&&t.fail(n.error);delete n.success;delete n.error;e.ajax(n).done(function(e){if(e==="1"||e===1)e={success:!0};_.isObject(e)&&!_.isUndefined(e.success)?t[e.success?"resolveWith":"rejectWith"](this,[e.data]):t.rejectWith(this,[e])}).fail(function(){t.rejectWith(this,arguments)})}).promise()},fit:function(e){var t=e.width,n=e.height,r=e.maxWidth,i=e.maxHeight,s;!_.isUndefined(r)&&!_.isUndefined(i)?s=t/n>r/i?"width":"height":_.isUndefined(i)?s="width":_.isUndefined(r)&&n>i&&(s="height");return"width"===s&&t>r?{width:r,height:Math.round(r*n/t)}:"height"===s&&n>i?{width:Math.round(i*t/n),height:i}:{width:t,height:n}},truncate:function(e,t,n){t=t||30;n=n||"&hellip;";return e.length<=t?e:e.substr(0,t/2)+n+e.substr(-1*t/2)}});o.attachment=function(e){return t.get(e)};t=o.model.Attachment=Backbone.Model.extend({sync:function(t,n,r){if(_.isUndefined(this.id))return e.Deferred().rejectWith(this).promise();if("read"===t){r=r||{};r.context=this;r.data=_.extend(r.data||{},{action:"get-attachment",id:this.id});return o.ajax(r)}if("update"===t){if(!this.get("nonces")||!this.get("nonces").update)return e.Deferred().rejectWith(this).promise();r=r||{};r.context=this;r.data=_.extend(r.data||{},{action:"save-attachment",id:this.id,nonce:this.get("nonces").update,post_id:o.model.settings.post.id});if(r.changes){_.each(r.changes,function(e,t){r.changes[t]=this.get(t)},this);r.data.changes=r.changes;delete r.changes}return o.ajax(r)}if("delete"===t){r=r||{};r.wait||(this.destroyed=!0);r.context=this;r.data=_.extend(r.data||{},{action:"delete-post",id:this.id,_wpnonce:this.get("nonces")["delete"]});return o.ajax(r).done(function(){this.destroyed=!0}).fail(function(){this.destroyed=!1})}},parse:function(e,t){if(!e)return e;e.date=new Date(e.date);e.modified=new Date(e.modified);return e},saveCompat:function(t,n){var r=this;return!this.get("nonces")||!this.get("nonces").update?e.Deferred().rejectWith(this).promise():o.post("save-attachment-compat",_.defaults({id:this.id,nonce:this.get("nonces").update,post_id:o.model.settings.post.id},t)).done(function(e,t,i){r.set(r.parse(e,i),n)})}},{create:function(e){return n.all.push(e)},get:_.memoize(function(e,t){return n.all.push(t||{id:e})})});n=o.model.Attachments=Backbone.Collection.extend({model:t,initialize:function(e,t){t=t||{};this.props=new Backbone.Model;this.filters=t.filters||{};this.props.on("change",this._changeFilteredProps,this);this.props.on("change:order",this._changeOrder,this);this.props.on("change:orderby",this._changeOrderby,this);this.props.on("change:query",this._changeQuery,this);this.props.set(_.defaults(t.props||{}));t.observe&&this.observe(t.observe)},_changeOrder:function(e,t){this.comparator&&this.sort()},_changeOrderby:function(e,t){if(this.comparator&&this.comparator!==n.comparator)return;t&&"post__in"!==t?this.comparator=n.comparator:delete this.comparator},_changeQuery:function(e,t){if(t){this.props.on("change",this._requery,this);this._requery()}else this.props.off("change",this._requery,this)},_changeFilteredProps:function(e,t){if(this.props.get("query"))return;var r=_.chain(t.changes).map(function(t,r){var i=n.filters[r],s=e.get(r);if(!i)return;if(s&&!this.filters[r])this.filters[r]=i;else{if(!!s||this.filters[r]!==i)return;delete this.filters[r]}return!0},this).any().value();if(!r)return;this._source||(this._source=new n(this.models));this.reset(this._source.filter(this.validator,this))},validateDestroyed:!1,validator:function(e){return!this.validateDestroyed&&e.destroyed?!1:_.all(this.filters,function(t,n){return!!t.call(this,e)},this)},validate:function(e,t){var n=this.validator(e),r=!!this.getByCid(e.cid);!n&&r?this.remove(e,t):n&&!r&&this.add(e,t);return this},validateAll:function(e,t){t=t||{};_.each(e.models,function(e){this.validate(e,{silent:!0})},this);t.silent||this.trigger("reset",this,t);return this},observe:function(e){this.observers=this.observers||[];this.observers.push(e);e.on("add change remove",this._validateHandler,this);e.on("reset",this._validateAllHandler,this);this.validateAll(e);return this},unobserve:function(e){if(e){e.off(null,null,this);this.observers=_.without(this.observers,e)}else{_.each(this.observers,function(e){e.off(null,null,this)},this);delete this.observers}return this},_validateHandler:function(e,t,n){n=t===this.mirroring?n:{silent:n&&n.silent};return this.validate(e,n)},_validateAllHandler:function(e,t){return this.validateAll(e,t)},mirror:function(e){if(this.mirroring&&this.mirroring===e)return this;this.unmirror();this.mirroring=e;this.reset([],{silent:!0});this.observe(e);return this},unmirror:function(){if(!this.mirroring)return;this.unobserve(this.mirroring);delete this.mirroring},more:function(t){var n=e.Deferred(),r=this.mirroring,i=this;if(!r||!r.more)return n.resolveWith(this).promise();r.more(t).done(function(){this===i.mirroring&&n.resolveWith(this)});return n.promise()},hasMore:function(){return this.mirroring?this.mirroring.hasMore():!1},parse:function(e,n){return _.map(e,function(e){var r=t.get(e.id);return r.set(r.parse(e,n))})},_requery:function(){this.props.get("query")&&this.mirror(r.get(this.props.toJSON()))},saveMenuOrder:function(){if("menuOrder"!==this.props.get("orderby"))return;var e=this.chain().filter(function(e){return!_.isUndefined(e.id)}).map(function(e,t){t+=1;e.set("menuOrder",t);return[e.id,t]}).object().value();if(_.isEmpty(e))return;return o.post("save-attachment-order",{nonce:o.model.settings.post.nonce,post_id:o.model.settings.post.id,attachments:e})}},{comparator:function(e,t,n){var r=this.props.get("orderby"),s=this.props.get("order")||"DESC",o=e.cid,u=t.cid;e=e.get(r);t=t.get(r);if("date"===r||"modified"===r){e=e||new Date;t=t||new Date}n&&n.ties&&(o=u=null);return"DESC"===s?i(e,t,o,u):i(t,e,u,o)},filters:{search:function(e){return this.props.get("search")?_.any(["title","filename","description","caption","name"],function(t){var n=e.get(t);return n&&-1!==n.search(this.props.get("search"))},this):!0},type:function(e){var t=this.props.get("type");return!t||-1!==t.indexOf(e.get("type"))},uploadedTo:function(e){var t=this.props.get("uploadedTo");return _.isUndefined(t)?!0:t===e.get("uploadedTo")}}});n.all=new n;o.query=function(e){return new n(null,{props:_.extend(_.defaults(e||{},{orderby:"date"}),{query:!0})})};r=o.model.Query=n.extend({initialize:function(e,t){var r;t=t||{};n.prototype.initialize.apply(this,arguments);this.args=t.args;this._hasMore=!0;this.created=new Date;this.filters.order=function(e){var t=this.props.get("orderby"),n=this.props.get("order");return this.comparator?this.length?1!==this.comparator(e,this.last(),{ties:!0}):"DESC"!==n||"date"!==t&&"modified"!==t?"ASC"===n&&"menuOrder"===t?e.get(t)===0:!1:e.get(t)>=this.created:!0};r=["s","order","orderby","posts_per_page","post_mime_type","post_parent"];wp.Uploader&&_(this.args).chain().keys().difference(r).isEmpty().value()&&this.observe(wp.Uploader.queue)},hasMore:function(){return this._hasMore},more:function(t){var n=this;if(this._more&&"pending"===this._more.state())return this._more;if(!this.hasMore())return e.Deferred().resolveWith(this).promise();t=t||{};t.add=!0;return this._more=this.fetch(t).done(function(e){if(_.isEmpty(e)||-1===this.args.posts_per_page||e.length<this.args.posts_per_page)n._hasMore=!1})},sync:function(e,t,r){var i;if("read"===e){r=r||{};r.context=this;r.data=_.extend(r.data||{},{action:"query-attachments",post_id:o.model.settings.post.id});args=_.clone(this.args);-1!==args.posts_per_page&&(args.paged=Math.floor(this.length/args.posts_per_page)+1);r.data.query=args;return o.ajax(r)}i=n.prototype.sync?n.prototype:Backbone;return i.sync.apply(this,arguments)}},{defaultProps:{orderby:"date",order:"DESC"},defaultArgs:{posts_per_page:40},orderby:{allowed:["name","author","date","title","modified","uploadedTo","id","post__in","menuOrder"],valuemap:{id:"ID",uploadedTo:"parent",menuOrder:"menu_order ID"}},propmap:{search:"s",type:"post_mime_type",perPage:"posts_per_page",menuOrder:"menu_order",uploadedTo:"post_parent"},get:function(){var e=[];return function(t,n){var i={},s=r.orderby,o=r.defaultProps,u;delete t.query;_.defaults(t,o);t.order=t.order.toUpperCase();"DESC"!==t.order&&"ASC"!==t.order&&(t.order=o.order.toUpperCase());_.contains(s.allowed,t.orderby)||(t.orderby=o.orderby);_.each(t,function(e,t){if(_.isNull(e))return;i[r.propmap[t]||t]=e});_.defaults(i,r.defaultArgs);i.orderby=s.valuemap[t.orderby]||t.orderby;u=_.find(e,function(e){return _.isEqual(e.args,i)});if(!u){u=new r([],_.extend(n||{},{props:t,args:i}));e.push(u)}return u}}()});o.model.Selection=n.extend({initialize:function(e,t){n.prototype.initialize.apply(this,arguments);this.multiple=t&&t.multiple;this.on("add remove reset",_.bind(this.single,this,!1))},add:function(e,t){this.multiple||this.remove(this.models);return n.prototype.add.call(this,e,t)},single:function(e){var t=this._single;e&&(this._single=e);this._single&&!this.getByCid(this._single.cid)&&delete this._single;this._single=this._single||this.last();if(this._single!==t){if(t){t.trigger("selection:unsingle",t,this);this.getByCid(t.cid)||this.trigger("selection:unsingle",t,this)}this._single&&this._single.trigger("selection:single",this._single,this)}return this._single}});e(window).on("unload",function(){window.wp=null})})(jQuery);