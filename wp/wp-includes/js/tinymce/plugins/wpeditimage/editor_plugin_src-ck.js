(function(){tinymce.create("tinymce.plugins.wpEditImage",{url:"",editor:{},init:function(e,t){var n=this,r={};n.url=t;n.editor=e;n._createButtons();e.addCommand("WP_EditImage",n._editImage);e.onInit.add(function(e){e.dom.events.add(e.getBody(),"mousedown",function(t){var n;t.target.nodeName=="IMG"&&(n=e.dom.getParent(t.target,"div.mceTemp"))&&(tinymce.isGecko?e.selection.select(n):tinymce.isWebKit&&e.dom.events.prevent(t))});e.dom.events.add(e.getBody(),"keydown",function(t){var n,r,i,s,o;if(t.keyCode==13){n=e.selection.getNode();r=e.dom.getParent(n,"dl.wp-caption");r&&(i=e.dom.getParent(r,"div.mceTemp"));if(i){e.dom.events.cancel(t);s=e.dom.create("p",{},"ï»¿");e.dom.insertAfter(s,i);e.selection.setCursorLocation(s,0);return!1}}});"ontouchstart"in window&&e.dom.events.add(e.getBody(),"touchstart",function(e){n._showButtons(e)})});e.onMouseUp.add(function(e,t){if(tinymce.isWebKit||tinymce.isOpera)return;if(r.x&&(t.clientX!=r.x||t.clientY!=r.y)){var n=e.selection.getNode();"IMG"==n.nodeName&&window.setTimeout(function(){var t=e.dom.getParent(n,"dl.wp-caption"),i;if(n.width!=r.img_w||n.height!=r.img_h)n.className=n.className.replace(/size-[^ "']+/,"");if(t){i=e.dom.getAttrib(n,"width")||n.width;i=parseInt(i,10);e.dom.setStyle(t,"width",10+i);e.execCommand("mceRepaint")}},100)}r={}});e.onMouseDown.add(function(e,t){n._showButtons(t)});e.onBeforeSetContent.add(function(e,t){t.content=e.wpSetImgCaption(t.content)});e.onPostProcess.add(function(e,t){t.get&&(t.content=e.wpGetImgCaption(t.content))});e.wpSetImgCaption=function(e){return n._do_shcode(e)};e.wpGetImgCaption=function(e){return n._get_shcode(e)};e.onBeforeExecCommand.add(function(e,t,n,r){var i,s;if(t=="mceInsertContent"){i=e.dom.getParent(e.selection.getNode(),"div.mceTemp");if(!i)return;s=e.dom.create("p");e.dom.insertAfter(s,i);e.selection.setCursorLocation(s,0)}})},_do_shcode:function(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,n){var r,i,s,o,u,a,f=tinymce.trim;r=t.match(/id=['"]([^'"]*)['"] ?/);r&&(t=t.replace(r[0],""));i=t.match(/align=['"]([^'"]*)['"] ?/);i&&(t=t.replace(i[0],""));s=t.match(/width=['"]([0-9]*)['"] ?/);s&&(t=t.replace(s[0],""));n=f(n);a=n.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i);if(a&&a[2]){o=f(a[2]);a=f(a[1])}else{o=f(t).replace(/caption=['"]/,"").replace(/['"]$/,"");a=n}r=r&&r[1]?r[1]:"";i=i&&i[1]?i[1]:"alignnone";s=s&&s[1]?s[1]:"";if(!s||!o)return n;u="mceTemp";i=="aligncenter"&&(u+=" mceIEcenter");return'<div class="'+u+'"><dl id="'+r+'" class="wp-caption '+i+'" style="width: '+(10+parseInt(s))+'px"><dt class="wp-caption-dt">'+a+'</dt><dd class="wp-caption-dd">'+o+"</dd></dl></div>"})},_get_shcode:function(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var n=t.replace(/<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>/gi,function(e,t,n,r){var i,s,o;o=n.match(/width="([0-9]*)"/);o=o&&o[1]?o[1]:"";if(!o||!r)return n;i=t.match(/id="([^"]*)"/);i=i&&i[1]?i[1]:"";s=t.match(/class="([^"]*)"/);s=s&&s[1]?s[1]:"";s=s.match(/align[a-z]+/)||"alignnone";r=r.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")});r=r.replace(/\s*\n\s*/g,"<br />");return'[caption id="'+i+'" align="'+s+'" width="'+o+'"]'+n+" "+r+"[/caption]"});n.indexOf("[caption")!==0&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"));return n})},_createButtons:function(){var e=this,t=tinymce.activeEditor,n=tinymce.DOM,r,i,s;if(n.get("wp_editbtns"))return;s=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches;n.add(document.body,"div",{id:"wp_editbtns",style:"display:none;"});r=n.add("wp_editbtns","img",{src:s?e.url+"/img/image-2x.png":e.url+"/img/image.png",id:"wp_editimgbtn",width:"24",height:"24",title:t.getLang("wpeditimage.edit_img")});tinymce.dom.Event.add(r,"mousedown",function(n){e._editImage();t.plugins.wordpress._hideButtons()});i=n.add("wp_editbtns","img",{src:s?e.url+"/img/delete-2x.png":e.url+"/img/delete.png",id:"wp_delimgbtn",width:"24",height:"24",title:t.getLang("wpeditimage.del_img")});tinymce.dom.Event.add(i,"mousedown",function(e){var t=tinymce.activeEditor,n=t.selection.getNode(),r;if(n.nodeName=="IMG"&&t.dom.getAttrib(n,"class").indexOf("mceItem")==-1){if((r=t.dom.getParent(n,"div"))&&t.dom.hasClass(r,"mceTemp"))t.dom.remove(r);else{n.parentNode.nodeName=="A"&&n.parentNode.childNodes.length==1&&(n=n.parentNode);n.parentNode.nodeName=="P"&&n.parentNode.childNodes.length==1&&(n=n.parentNode);t.dom.remove(n)}t.execCommand("mceRepaint");return!1}t.plugins.wordpress._hideButtons()})},_editImage:function(){var e=tinymce.activeEditor,t=this.url,n=e.selection.getNode(),r,i,s,o=n.className;if(o.indexOf("mceItem")!=-1||o.indexOf("wpGallery")!=-1||n.nodeName!="IMG")return;r=tinymce.DOM.getViewPort();i=680<r.h-70?680:r.h-70;s=650<r.w?650:r.w;e.windowManager.open({file:t+"/editimage.html",width:s+"px",height:i+"px",inline:!0})},_showButtons:function(e){var t=this.editor,n=e.target;if(n.nodeName!="IMG"){if(!n.firstChild||n.firstChild.nodeName!="IMG"||n.childNodes.length!=1){t.plugins.wordpress._hideButtons();return}n=n.firstChild}if(t.dom.getAttrib(n,"class").indexOf("mceItem")==-1){mouse={x:e.clientX,y:e.clientY,img_w:n.clientWidth,img_h:n.clientHeight};if(e.type=="touchstart"){t.selection.select(n);t.dom.events.cancel(e)}t.plugins.wordpress._hideButtons();t.plugins.wordpress._showButtons(n,"wp_editbtns")}},getInfo:function(){return{longname:"Edit Image",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}});tinymce.PluginManager.add("wpeditimage",tinymce.plugins.wpEditImage)})();