var tinymce=null,tinyMCEPopup,tinyMCE,wpImage;tinyMCEPopup={init:function(){var e=this,t,n;t=e.getWin();tinymce=t.tinymce;tinyMCE=t.tinyMCE;e.editor=tinymce.EditorManager.activeEditor;e.params=e.editor.windowManager.params;e.features=e.editor.windowManager.features;e.dom=e.editor.windowManager.createInstance("tinymce.dom.DOMUtils",document);e.editor.windowManager.onOpen.dispatch(e.editor.windowManager,window)},getWin:function(){return!window.frameElement&&window.dialogArguments||opener||parent||top},getParam:function(e,t){return this.editor.getParam(e,t)},close:function(){function t(){e.editor.windowManager.close(window);tinymce=tinyMCE=e.editor=e.params=e.dom=e.dom.doc=null}var e=this;tinymce.isOpera?e.getWin().setTimeout(t,0):t()},execCommand:function(e,t,n,r){r=r||{};r.skip_focus=1;this.restoreSelection();return this.editor.execCommand(e,t,n,r)},storeSelection:function(){this.editor.windowManager.bookmark=tinyMCEPopup.editor.selection.getBookmark(1)},restoreSelection:function(){var e=tinyMCEPopup;tinymce.isIE&&e.editor.selection.moveToBookmark(e.editor.windowManager.bookmark)}};tinyMCEPopup.init();wpImage={preInit:function(){var e=tinyMCEPopup.editor,t=tinyMCEPopup.getWin(),n=t.document.styleSheets,r,i;for(i=0;i<n.length;i++){r=n.item(i).href;if(r&&r.indexOf("colors")!=-1){document.getElementsByTagName("head")[0].appendChild(e.dom.create("link",{rel:"stylesheet",href:r}));break}}},I:function(e){return document.getElementById(e)},current:"",link:"",link_rel:"",target_value:"",current_size_sel:"s100",width:"",height:"",align:"",img_alt:"",setTabs:function(e){var t=this;if("current"==e.className)return!1;t.I("div_advanced").style.display="tab_advanced"==e.id?"block":"none";t.I("div_basic").style.display="tab_basic"==e.id?"block":"none";t.I("tab_basic").className=t.I("tab_advanced").className="";e.className="current";return!1},img_seturl:function(e){var t=this,n=t.I("link_rel").value;if("current"==e){t.I("link_href").value=t.current;t.I("link_rel").value=t.link_rel}else{t.I("link_href").value=t.link;if(n){n=n.replace(/attachment|wp-att-[0-9]+/gi,"");t.I("link_rel").value=tinymce.trim(n)}}},imgAlignCls:function(e){var t=this,n=t.I("img_classes").value;t.I("img_demo").className=t.align=e;n=n.replace(/align[^ "']+/gi,"");n+=" "+e;n=n.replace(/\s+/g," ").replace(/^\s/,"");if("aligncenter"==e){t.I("hspace").value="";t.updateStyle("hspace")}t.I("img_classes").value=n},showSize:function(e){var t=this,n=t.I("img_demo"),r=t.width,i=t.height,s=e.id||"s100",o;o=parseInt(s.substring(1))/200;n.width=Math.round(r*o);n.height=Math.round(i*o);t.showSizeClear();e.style.borderColor="#A3A3A3";e.style.backgroundColor="#E5E5E5"},showSizeSet:function(){var e=this,t,n,r;if(e.width*1.3>parseInt(e.preloadImg.width)){t=e.I("s130"),n=e.I("s120"),r=e.I("s110");t.onclick=n.onclick=r.onclick=null;t.onmouseover=n.onmouseover=r.onmouseover=null;t.style.color=n.style.color=r.style.color="#aaa"}},showSizeRem:function(){var e=this,t=e.I("img_demo"),n=document.forms[0];t.width=Math.round(n.width.value*.5);t.height=Math.round(n.height.value*.5);e.showSizeClear();e.I(e.current_size_sel).style.borderColor="#A3A3A3";e.I(e.current_size_sel).style.backgroundColor="#E5E5E5";return!1},showSizeClear:function(){var e=this.I("img_size").getElementsByTagName("div"),t;for(t=0;t<e.length;t++){e[t].style.borderColor="#f1f1f1";e[t].style.backgroundColor="#f1f1f1"}},imgEditSize:function(e){var t=this,n=document.forms[0],r,i,s,o,u;if(!t.preloadImg||!t.preloadImg.width||!t.preloadImg.height)return;r=parseInt(t.preloadImg.width),i=parseInt(t.preloadImg.height),s=t.width||r,o=t.height||i,u=e.id||"s100";size=parseInt(u.substring(1))/100;s=Math.round(s*size);o=Math.round(o*size);n.width.value=Math.min(r,s);n.height.value=Math.min(i,o);t.current_size_sel=u;t.demoSetSize()},demoSetSize:function(e){var t=this.I("img_demo"),n=document.forms[0];t.width=n.width.value?Math.round(n.width.value*.5):"";t.height=n.height.value?Math.round(n.height.value*.5):""},demoSetStyle:function(){var e=document.forms[0],t=this.I("img_demo"),n=tinyMCEPopup.editor.dom;if(t){n.setAttrib(t,"style",e.img_style.value);n.setStyle(t,"width","");n.setStyle(t,"height","")}},origSize:function(){var e=this,t=document.forms[0],n=e.I("s100");t.width.value=e.width=e.preloadImg.width;t.height.value=e.height=e.preloadImg.height;e.showSizeSet();e.demoSetSize();e.showSize(n)},init:function(){var e=tinyMCEPopup.editor,t;t=document.body.innerHTML;document.body.innerHTML=e.translate(t);window.setTimeout(function(){wpImage.setup()},500)},setup:function(){var e=this,t,n,r,i,s=document.forms[0],o=tinyMCEPopup.editor,u=e.I("img_demo"),a=tinyMCEPopup.dom,f,l,c="",h,p;document.dir=tinyMCEPopup.editor.getParam("directionality","");tinyMCEPopup.editor.getParam("wpeditimage_disable_captions",!1)&&(e.I("cap_field").style.display="none");tinyMCEPopup.restoreSelection();n=o.selection.getNode();if(n.nodeName!="IMG")return;s.img_src.value=u.src=r=o.dom.getAttrib(n,"src");o.dom.setStyle(n,"float","");e.getImageData();t=o.dom.getAttrib(n,"class");if(f=a.getParent(n,"dl")){h=o.dom.getAttrib(f,"class");h=h.match(/align[^ "']+/i);if(h&&!a.hasClass(n,h)){t+=" "+h;tinymce.trim(t)}l=o.dom.select("dd.wp-caption-dd",f);l&&l[0]&&(c=o.serializer.serialize(l[0]).replace(/^<p>/,"").replace(/<\/p>$/,""))}s.img_cap_text.value=c;s.img_title.value=o.dom.getAttrib(n,"title");s.img_alt.value=o.dom.getAttrib(n,"alt");s.border.value=o.dom.getAttrib(n,"border");s.vspace.value=o.dom.getAttrib(n,"vspace");s.hspace.value=o.dom.getAttrib(n,"hspace");s.align.value=o.dom.getAttrib(n,"align");s.width.value=e.width=o.dom.getAttrib(n,"width");s.height.value=e.height=o.dom.getAttrib(n,"height");s.img_classes.value=t;s.img_style.value=o.dom.getAttrib(n,"style");a.getAttrib(n,"hspace")&&e.updateStyle("hspace");a.getAttrib(n,"border")&&e.updateStyle("border");a.getAttrib(n,"vspace")&&e.updateStyle("vspace");if(p=o.dom.getParent(n,"A")){s.link_href.value=e.current=o.dom.getAttrib(p,"href");s.link_title.value=o.dom.getAttrib(p,"title");s.link_rel.value=e.link_rel=o.dom.getAttrib(p,"rel");s.link_style.value=o.dom.getAttrib(p,"style");e.target_value=o.dom.getAttrib(p,"target");s.link_classes.value=o.dom.getAttrib(p,"class")}s.link_target.checked=e.target_value&&e.target_value=="_blank"?"checked":"";i=r.substring(r.lastIndexOf("/"));i=i.replace(/-[0-9]{2,4}x[0-9]{2,4}/,"");e.link=r.substring(0,r.lastIndexOf("/"))+i;if(t.indexOf("alignleft")!=-1){e.I("alignleft").checked="checked";u.className=e.align="alignleft"}else if(t.indexOf("aligncenter")!=-1){e.I("aligncenter").checked="checked";u.className=e.align="aligncenter"}else if(t.indexOf("alignright")!=-1){e.I("alignright").checked="checked";u.className=e.align="alignright"}else if(t.indexOf("alignnone")!=-1){e.I("alignnone").checked="checked";u.className=e.align="alignnone"}e.width&&e.preloadImg.width&&e.showSizeSet();document.body.style.display=""},remove:function(){var e=tinyMCEPopup.editor,t,n;tinyMCEPopup.restoreSelection();n=e.selection.getNode();if(n.nodeName!="IMG")return;(t=e.dom.getParent(n,"div"))&&e.dom.hasClass(t,"mceTemp")?e.dom.remove(t):(t=e.dom.getParent(n,"A"))&&t.childNodes.length==1?e.dom.remove(t):e.dom.remove(n);e.execCommand("mceRepaint");tinyMCEPopup.close();return},update:function(){var e=this,t=document.forms[0],n=tinyMCEPopup.editor,r,i,s=null,o,u,a,f,l=null,c=t.img_classes.value,h,p,d="",v,m,g,y,b,w="",E,S,x;tinyMCEPopup.restoreSelection();r=n.selection.getNode();if(r.nodeName!="IMG")return;if(t.img_src.value===""){e.remove();return}if(t.img_cap_text.value!=""&&t.width.value!=""){l=1;c=c.replace(/align[^ "']+\s?/gi,"")}a=n.dom.getParent(r,"a");u=n.dom.getParent(r,"p");o=n.dom.getParent(r,"dl");f=n.dom.getParent(r,"div");tinyMCEPopup.execCommand("mceBeginUndoLevel");if(t.width.value!=r.width||t.height.value!=r.height)c=c.replace(/size-[^ "']+/,"");n.dom.setAttribs(r,{src:t.img_src.value,title:t.img_title.value,alt:t.img_alt.value,width:t.width.value,height:t.height.value,style:t.img_style.value,"class":c});if(t.link_href.value)if(a==null){t.link_href.value.match(/https?:\/\//i)||(t.link_href.value=tinyMCEPopup.editor.documentBaseURI.toAbsolute(t.link_href.value));n.getDoc().execCommand("unlink",!1,null);tinyMCEPopup.execCommand("mceInsertLink",!1,"#mce_temp_url#",{skip_undo:1});tinymce.each(n.dom.select("a"),function(e){n.dom.getAttrib(e,"href")=="#mce_temp_url#"&&n.dom.setAttribs(e,{href:t.link_href.value,title:t.link_title.value,rel:t.link_rel.value,target:t.link_target.checked==1?"_blank":"","class":t.link_classes.value,style:t.link_style.value})})}else n.dom.setAttribs(a,{href:t.link_href.value,title:t.link_title.value,rel:t.link_rel.value,target:t.link_target.checked==1?"_blank":"","class":t.link_classes.value,style:t.link_style.value});if(l){y=10+parseInt(t.width.value);b=e.align=="aligncenter"?"mceTemp mceIEcenter":"mceTemp";x=t.img_cap_text.value;x=x.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")});x=x.replace(/\s*\n\s*/g,"<br />");if(o){n.dom.setAttribs(o,{"class":"wp-caption "+e.align,style:"width: "+y+"px;"});f&&n.dom.setAttrib(f,"class",b);(m=n.dom.getParent(r,"dt"))&&(g=m.nextSibling)&&n.dom.hasClass(g,"wp-caption-dd")&&n.dom.setHTML(g,x)}else{(p=t.img_classes.value.match(/wp-image-([0-9]{1,6})/))&&p[1]&&(d="attachment_"+p[1]);if(t.link_href.value&&(w=n.dom.getParent(r,"a")))if(w.childNodes.length==1)h=n.dom.getOuterHTML(w);else{h=n.dom.getOuterHTML(w);h=h.match(/<a [^>]+>/i);h=h+n.dom.getOuterHTML(r)+"</a>"}else h=n.dom.getOuterHTML(r);h='<dl id="'+d+'" class="wp-caption '+e.align+'" style="width: '+y+'px"><dt class="wp-caption-dt">'+h+'</dt><dd class="wp-caption-dd">'+x+"</dd></dl>";v=n.dom.create("div",{"class":b},h);if(u){u.parentNode.insertBefore(v,u);u.childNodes.length==1?n.dom.remove(u):w&&w.childNodes.length==1?n.dom.remove(w):n.dom.remove(r)}else if(E=n.dom.getParent(r,"TD,TH,LI")){E.appendChild(v);w&&w.childNodes.length==1?n.dom.remove(w):n.dom.remove(r)}}}else if(o&&f){t.link_href.value&&(S=n.dom.getParent(r,"a"))?h=n.dom.getOuterHTML(S):h=n.dom.getOuterHTML(r);u=n.dom.create("p",{},h);f.parentNode.insertBefore(u,f);n.dom.remove(f)}t.img_classes.value.indexOf("aligncenter")!=-1?u&&(!u.style||u.style.textAlign!="center")&&n.dom.setStyle(u,"textAlign","center"):u&&u.style&&u.style.textAlign=="center"&&n.dom.setStyle(u,"textAlign","");if(!t.link_href.value&&a){i=n.selection.getBookmark();n.dom.remove(a,1);n.selection.moveToBookmark(i)}tinyMCEPopup.execCommand("mceEndUndoLevel");n.execCommand("mceRepaint");tinyMCEPopup.close()},updateStyle:function(e){var t=tinyMCEPopup.dom,n,r=document.forms[0],i=t.create("img",{style:r.img_style.value});if(tinyMCEPopup.editor.settings.inline_styles){if(e=="align"){t.setStyle(i,"float","");t.setStyle(i,"vertical-align","");n=r.align.value;n&&(n=="left"||n=="right"?t.setStyle(i,"float",n):i.style.verticalAlign=n)}if(e=="border"){t.setStyle(i,"border","");n=r.border.value;if(n||n=="0")n=="0"?i.style.border="0":i.style.border=n+"px solid black"}if(e=="hspace"){t.setStyle(i,"marginLeft","");t.setStyle(i,"marginRight","");n=r.hspace.value;if(n){i.style.marginLeft=n+"px";i.style.marginRight=n+"px"}}if(e=="vspace"){t.setStyle(i,"marginTop","");t.setStyle(i,"marginBottom","");n=r.vspace.value;if(n){i.style.marginTop=n+"px";i.style.marginBottom=n+"px"}}r.img_style.value=t.serializeStyle(t.parseStyle(i.style.cssText));this.demoSetStyle()}},checkVal:function(e){e.value==""&&e.id=="img_src"&&(e.value=this.I("img_demo").src||this.preloadImg.src)},resetImageData:function(){var e=document.forms[0];e.width.value=e.height.value=""},updateImageData:function(){var e=document.forms[0],t=wpImage,n=e.width.value,r=e.height.value;!n&&r?n=e.width.value=t.width=Math.round(t.preloadImg.width/(t.preloadImg.height/r)):n&&!r&&(r=e.height.value=t.height=Math.round(t.preloadImg.height/(t.preloadImg.width/n)));n||(e.width.value=t.width=t.preloadImg.width);r||(e.height.value=t.height=t.preloadImg.height);t.showSizeSet();t.demoSetSize();e.img_style.value&&t.demoSetStyle()},getImageData:function(){var e=wpImage,t=document.forms[0];e.preloadImg=new Image;e.preloadImg.onload=e.updateImageData;e.preloadImg.onerror=e.resetImageData;e.preloadImg.src=tinyMCEPopup.editor.documentBaseURI.toAbsolute(t.img_src.value)}};window.onload=function(){wpImage.init()};wpImage.preInit();