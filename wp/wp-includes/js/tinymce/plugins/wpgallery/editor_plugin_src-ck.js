(function(){tinymce.create("tinymce.plugins.wpGallery",{init:function(e,t){var n=this;n.url=t;n.editor=e;n._createButtons();e.addCommand("WP_Gallery",function(){tinymce.isIE&&e.selection.moveToBookmark(e.wpGalleryBookmark);var t=e.selection.getNode(),n=wp.media.gallery,r;if(typeof wp=="undefined"||!wp.media||!wp.media.gallery)return;if(t.nodeName!="IMG"||e.dom.getAttrib(t,"class").indexOf("wpGallery")==-1)return;r=n.edit("["+e.dom.getAttrib(t,"title")+"]");r.state("gallery-edit").on("update",function(r){var i=n.shortcode(r).string().slice(1,-1);e.dom.setAttrib(t,"title",i)})});e.onInit.add(function(e){"ontouchstart"in window&&e.dom.events.add(e.getBody(),"touchstart",function(t){var n=t.target;if(n.nodeName=="IMG"&&e.dom.hasClass(n,"wpGallery")){e.selection.select(n);e.dom.events.cancel(t);e.plugins.wordpress._hideButtons();e.plugins.wordpress._showButtons(n,"wp_gallerybtns")}})});e.onMouseDown.add(function(e,t){if(t.target.nodeName=="IMG"&&e.dom.hasClass(t.target,"wpGallery")){e.plugins.wordpress._hideButtons();e.plugins.wordpress._showButtons(t.target,"wp_gallerybtns")}});e.onBeforeSetContent.add(function(e,t){t.content=n._do_gallery(t.content)});e.onPostProcess.add(function(e,t){t.get&&(t.content=n._get_gallery(t.content))})},_do_gallery:function(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e,t){return'<img src="'+tinymce.baseURL+'/plugins/wpgallery/img/t.gif" class="wpGallery mceItem" title="gallery'+tinymce.DOM.encode(t)+'" />'})},_get_gallery:function(e){function t(e,t){t=(new RegExp(t+'="([^"]+)"',"g")).exec(e);return t?tinymce.DOM.decode(t[1]):""}return e.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,n){var r=t(n,"class");return r.indexOf("wpGallery")!=-1?"<p>["+tinymce.trim(t(n,"title"))+"]</p>":e})},_createButtons:function(){var e=this,t=tinymce.activeEditor,n=tinymce.DOM,r,i,s;if(n.get("wp_gallerybtns"))return;s=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches;n.add(document.body,"div",{id:"wp_gallerybtns",style:"display:none;"});r=n.add("wp_gallerybtns","img",{src:s?e.url+"/img/edit-2x.png":e.url+"/img/edit.png",id:"wp_editgallery",width:"24",height:"24",title:t.getLang("wordpress.editgallery")});tinymce.dom.Event.add(r,"mousedown",function(e){var t=tinymce.activeEditor;t.wpGalleryBookmark=t.selection.getBookmark("simple");t.execCommand("WP_Gallery");t.plugins.wordpress._hideButtons()});i=n.add("wp_gallerybtns","img",{src:s?e.url+"/img/delete-2x.png":e.url+"/img/delete.png",id:"wp_delgallery",width:"24",height:"24",title:t.getLang("wordpress.delgallery")});tinymce.dom.Event.add(i,"mousedown",function(e){var t=tinymce.activeEditor,n=t.selection.getNode();if(n.nodeName=="IMG"&&t.dom.hasClass(n,"wpGallery")){t.dom.remove(n);t.execCommand("mceRepaint");t.dom.events.cancel(e)}t.plugins.wordpress._hideButtons()})},getInfo:function(){return{longname:"Gallery Settings",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}});tinymce.PluginManager.add("wpgallery",tinymce.plugins.wpGallery)})();